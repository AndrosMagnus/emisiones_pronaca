<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puntos de Emisiones - Pronaca</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Panel lateral */
        #sidebar {
            width: 350px;
            background: white;
            border-right: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #sidebar-header {
            background: linear-gradient(135deg, #2F75B5 0%, #1a4d7a 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        #sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        #sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        /* B√∫squeda */
        #search-container {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        #search-input {
            width: 100%;
            padding: 10px 38px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        #search-input:focus {
            outline: none;
            border-color: #2F75B5;
            box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.1);
        }

        .search-input-wrapper {
            position: relative;
        }

        #clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 50%;
            background: #e9ecef;
            color: #666;
            cursor: pointer;
            font-weight: bold;
            line-height: 22px;
            padding: 0;
            display: none;
        }

        #clear-search.visible {
            display: block;
        }

        #clear-search:hover {
            background: #d7dbe0;
        }

        #clear-search:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(47, 117, 181, 0.2);
        }

        /* Lista de puntos */
        #points-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .point-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .point-item:hover {
            background: #f0f7ff;
            border-color: #2F75B5;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(47, 117, 181, 0.2);
        }

        .point-item.active {
            background: #e3f2fd;
            border-color: #2F75B5;
            border-width: 2px;
        }

        .point-name {
            font-weight: bold;
            color: #2F75B5;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .point-species {
            color: #28a745;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .point-coords {
            color: #666;
            font-size: 11px;
        }

        .no-results {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        /* Estad√≠sticas */
        #stats {
            background: #f8f9fa;
            padding: 10px 15px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }

        /* Mapa */
        #map {
            flex: 1;
            height: 100vh;
        }

        /* Popup personalizado */
        .leaflet-popup-content {
            margin: 15px;
            font-size: 13px;
        }

        .popup-title {
            font-weight: bold;
            color: #2F75B5;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 2px solid #2F75B5;
            padding-bottom: 5px;
        }

        .popup-row {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .popup-label {
            font-weight: bold;
            color: #555;
        }

        .popup-value {
            color: #333;
        }

        /* Control de capas personalizado */
        .layer-control {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Tooltip */
        .leaflet-tooltip {
            background: rgba(47, 117, 181, 0.95);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                max-width: 300px;
                position: absolute;
                z-index: 1000;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            #toggle-sidebar {
                display: block;
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1001;
                background: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }
        }

        #toggle-sidebar {
            display: none;
        }
    </style>
</head>

<body>
    <div id="container">
        <!-- Panel lateral -->
        <div id="sidebar">
            <div id="sidebar-header">
                <h1>üí® Emisiones de Metano</h1>
                <p>Control de Emisiones Pronaca - 2025</p>
            </div>

            <div id="search-container">
                <div class="search-input-wrapper">
                    <input type="text" id="search-input" placeholder="Buscar centro..." autocomplete="off">
                    <button type="button" id="clear-search" aria-label="Limpiar busqueda">X</button>
                </div>
            </div>

            <div id="points-list"></div>

            <div id="stats">
                <strong>Total ubicaciones:</strong> <span id="total-count">0</span> |
                <strong>Mostrando:</strong> <span id="visible-count">0</span>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map"></div>
    </div>

    <button id="toggle-sidebar">‚ò∞</button>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Inicializar mapa
        const map = L.map('map').setView([-1.5, -79.4], 9);

        // Capas base
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '(C) OpenStreetMap contributors',
            maxZoom: 19
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles (C) Esri',
            maxZoom: 19
        });

        const hybrid = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles (C) Esri',
            maxZoom: 19
        });

        const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
            attribution: '(C) CartoDB',
            maxZoom: 19
        });

        // Agregar capa base por defecto
        hybrid.addTo(map);
        labels.addTo(map);

        // Control de capas
        const baseMaps = {
            "Satelite": hybrid,
            "Mapa": osm
        };

        // Grupo para los puntos de emision (preparado para poligonos futuros)
        const centrosLayer = L.layerGroup().addTo(map);
        const poligonosLayer = L.layerGroup(); // Preparado para futuros poligonos

        const overlayMaps = {
            "Centros de emision": centrosLayer,
            "Poligonos": poligonosLayer  // Estara vacio hasta que agreguen los poligonos
        };

        L.control.layers(baseMaps, overlayMaps, {
            position: 'topright',
            collapsed: false
        }).addTo(map);

        // Datos de centros de emision (se cargaran desde centros_emision_metano.geojson)
        let centros = [];
        let markers = [];

        function formatValue(value, fallback = 'N/A') {
            if (value === null || value === undefined) return fallback;
            const text = String(value).trim();
            return text === '' ? fallback : text;
        }

        // Funcion para crear popup
        function createPopup(feature) {
            const props = feature.properties || {};
            const coords = feature.geometry && feature.geometry.coordinates ? feature.geometry.coordinates : null;
            const lat = coords ? coords[1].toFixed(5) : 'N/A';
            const lon = coords ? coords[0].toFixed(5) : 'N/A';

            return `
                <div class="popup-title">${formatValue(props.nombre_instalacion, 'Sin nombre')}</div>
                <div class="popup-row">
                    <span class="popup-label">Tipo:</span>
                    <span class="popup-value">${formatValue(props.tipo)}</span>
                </div>
                <div class="popup-row">
                    <span class="popup-label">Nombre comercial:</span>
                    <span class="popup-value">${formatValue(props.nombre_comercial_ruc)}</span>
                </div>
                <div class="popup-row">
                    <span class="popup-label">Est. RUC:</span>
                    <span class="popup-value">${formatValue(props.est_ruc)}</span>
                </div>
                <div class="popup-row">
                    <span class="popup-label">Provincia:</span>
                    <span class="popup-value">${formatValue(props.provincia)}</span>
                </div>
                <div class="popup-row">
                    <span class="popup-label">Canton:</span>
                    <span class="popup-value">${formatValue(props.canton)}</span>
                </div>
                <div class="popup-row">
                    <span class="popup-label">Parroquia:</span>
                    <span class="popup-value">${formatValue(props.parroquia)}</span>
                </div>
                <div class="popup-row">
                    <span class="popup-label">Direccion:</span>
                    <span class="popup-value">${formatValue(props.direccion)}</span>
                </div>
                <div class="popup-row" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <span class="popup-label">Coordenadas:</span>
                    <span class="popup-value" style="font-size: 10px;">${lat}, ${lon}</span>
                </div>
            `;
        }

        function buildSearchText(ubicacion) {
            const tokens = new Set();
            ubicacion.nombres.forEach(value => tokens.add(value));
            ubicacion.tipos.forEach(value => tokens.add(value));
            ubicacion.provincias.forEach(value => tokens.add(value));
            ubicacion.cantones.forEach(value => tokens.add(value));
            ubicacion.parroquias.forEach(value => tokens.add(value));

            ubicacion.features.forEach(feature => {
                const props = feature.properties || {};
                const comercial = formatValue(props.nombre_comercial_ruc, '');
                if (comercial) tokens.add(comercial);
                const direccion = formatValue(props.direccion, '');
                if (direccion) tokens.add(direccion);
                const estRuc = formatValue(props.est_ruc, '');
                if (estRuc) tokens.add(estRuc);
            });

            return Array.from(tokens).join(' ').toLowerCase();
        }

        // Funcion para cargar centros de emision
        function loadCentros(geojsonData) {
            const ubicaciones = new Map();

            geojsonData.features.forEach(feature => {
                if (!feature || !feature.geometry || !feature.geometry.coordinates) return;
                const coords = feature.geometry.coordinates.join(',');
                const props = feature.properties || {};
                const nombre = formatValue(props.nombre_instalacion, 'Sin nombre');

                if (!ubicaciones.has(coords)) {
                    ubicaciones.set(coords, {
                        nombre: nombre,
                        nombres: new Set([nombre]),
                        tipos: new Set([formatValue(props.tipo, '')].filter(Boolean)),
                        provincias: new Set([formatValue(props.provincia, '')].filter(Boolean)),
                        cantones: new Set([formatValue(props.canton, '')].filter(Boolean)),
                        parroquias: new Set([formatValue(props.parroquia, '')].filter(Boolean)),
                        coords: feature.geometry.coordinates,
                        features: [feature]
                    });
                } else {
                    const ubicacion = ubicaciones.get(coords);
                    ubicacion.nombres.add(nombre);

                    const tipo = formatValue(props.tipo, '');
                    if (tipo) ubicacion.tipos.add(tipo);
                    const provincia = formatValue(props.provincia, '');
                    if (provincia) ubicacion.provincias.add(provincia);
                    const canton = formatValue(props.canton, '');
                    if (canton) ubicacion.cantones.add(canton);
                    const parroquia = formatValue(props.parroquia, '');
                    if (parroquia) ubicacion.parroquias.add(parroquia);

                    ubicacion.features.push(feature);
                }
            });

            centros = Array.from(ubicaciones.values());
            centros.forEach(ubicacion => {
                ubicacion.searchText = buildSearchText(ubicacion);
            });

            centrosLayer.clearLayers();
            markers = [];

            // Crear marcadores
            centros.forEach((ubicacion, index) => {
                const coords = ubicacion.coords;
                const latlng = [coords[1], coords[0]]; // Leaflet usa [lat, lng]
                const nombres = Array.from(ubicacion.nombres);
                const displayName = nombres.length > 1 ? `${nombres[0]} (+${nombres.length - 1})` : nombres[0];

                const marker = L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: '#dc3545',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                const popupContent = ubicacion.features.map(f => createPopup(f)).join('<hr style="margin: 10px 0;">');
                marker.bindPopup(popupContent, { maxWidth: 300 });

                marker.bindTooltip(displayName, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -10]
                });

                marker.addTo(centrosLayer);

                markers.push({
                    marker: marker,
                    data: ubicacion,
                    index: index
                });
            });

            if (markers.length > 0) {
                const group = L.featureGroup(markers.map(m => m.marker));
                map.fitBounds(group.getBounds().pad(0.1));
            }

            renderList();
        }

        // Funcion para renderizar lista
        function renderList(filter = '') {
            const listContainer = document.getElementById('points-list');
            const normalized = filter.trim().toLowerCase();
            const filtered = normalized
                ? centros.filter(p => p.searchText && p.searchText.includes(normalized))
                : centros;

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div class="no-results">No se encontraron resultados</div>';
            } else {
                listContainer.innerHTML = filtered.map((ubicacion) => {
                    const nombres = Array.from(ubicacion.nombres);
                    const displayName = nombres.length > 1 ? `${nombres[0]} (+${nombres.length - 1})` : nombres[0];
                    const provincias = Array.from(ubicacion.provincias).join('; ');
                    const cantones = Array.from(ubicacion.cantones).join('; ');
                    const totalRegistros = ubicacion.features.length;
                    const locationParts = [];
                    if (provincias) locationParts.push(`Provincia: ${provincias}`);
                    if (cantones) locationParts.push(`Canton: ${cantones}`);
                    const locationLine = locationParts.length > 0 ? locationParts.join(' | ') : 'Ubicacion sin datos';

                    return `
                        <div class="point-item" data-index="${centros.indexOf(ubicacion)}">
                            <div class="point-name">${displayName}</div>
                            <div class="point-species">${locationLine}</div>
                            <div class="point-coords">Registros: ${totalRegistros}</div>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.point-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const index = parseInt(this.dataset.index, 10);
                        const markerData = markers.find(m => m.index === index);

                        if (markerData) {
                            map.setView(markerData.marker.getLatLng(), 15);
                            markerData.marker.openPopup();

                            document.querySelectorAll('.point-item').forEach(i => i.classList.remove('active'));
                            this.classList.add('active');
                        }
                    });
                });
            }

            document.getElementById('total-count').textContent = centros.length;
            document.getElementById('visible-count').textContent = filtered.length;
        }

        const searchInput = document.getElementById('search-input');
        const clearSearch = document.getElementById('clear-search');

        function updateClearButton() {
            if (searchInput.value.trim() === '') {
                clearSearch.classList.remove('visible');
            } else {
                clearSearch.classList.add('visible');
            }
        }

        searchInput.addEventListener('input', function (e) {
            renderList(e.target.value);
            updateClearButton();
        });

        clearSearch.addEventListener('click', function () {
            searchInput.value = '';
            renderList('');
            updateClearButton();
            searchInput.focus();
        });

        document.getElementById('toggle-sidebar').addEventListener('click', function () {
            document.getElementById('sidebar').classList.toggle('open');
        });

        // Cargar datos desde archivo externo (con cache-busting)
        fetch('centros_emision_metano.geojson?v=' + Date.now())
            .then(response => response.json())
            .then(data => loadCentros(data))
            .catch(error => {
                console.error('Error cargando datos:', error);
                alert('Error al cargar los datos de los centros de emision');
            });
    </script>
</body>

</html>

<!-- Script adicional para cargar pol√≠gonos cuando est√©n disponibles -->
<script>
    // Funci√≥n para cargar pol√≠gonos (se ejecuta autom√°ticamente)
    function loadPoligonos() {
        fetch('poligonos.geojson')
            .then(response => {
                if (!response.ok) {
                    console.log('Archivo de pol√≠gonos no encontrado a√∫n. Esto es normal si a√∫n no los han agregado.');
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.features && data.features.length > 0) {
                    // Agregar pol√≠gonos al mapa
                    L.geoJSON(data, {
                        style: function (feature) {
                            return {
                                color: '#28a745',
                                weight: 2,
                                fillOpacity: 0.3
                            };
                        },
                        onEachFeature: function (feature, layer) {
                            if (feature.properties) {
                                const props = feature.properties;
                                let popupContent = '<div class="popup-title">' + (props.nombre || props.plantacion || 'Plantaci√≥n') + '</div>';

                                if (props.especie) popupContent += '<div class="popup-row"><span class="popup-label">Especie:</span><span class="popup-value">' + props.especie + '</span></div>';
                                if (props.hectareas) popupContent += '<div class="popup-row"><span class="popup-label">Hect√°reas:</span><span class="popup-value">' + props.hectareas + ' ha</span></div>';
                                if (props.a√±o) popupContent += '<div class="popup-row"><span class="popup-label">A√±o:</span><span class="popup-value">' + props.a√±o + '</span></div>';

                                layer.bindPopup(popupContent);
                                layer.bindTooltip(props.nombre || props.plantacion || 'Plantaci√≥n', {
                                    permanent: false,
                                    direction: 'center'
                                });
                            }
                        }
                    }).addTo(poligonosLayer);

                    // Agregar la capa de pol√≠gonos al mapa autom√°ticamente
                    poligonosLayer.addTo(map);

                    console.log('‚úÖ Pol√≠gonos cargados exitosamente:', data.features.length, 'pol√≠gonos');
                }
            })
            .catch(error => {
                console.log('Los pol√≠gonos a√∫n no est√°n disponibles. Se cargar√°n autom√°ticamente cuando se agregue el archivo poligonos.geojson');
            });
    }

    // Intentar cargar pol√≠gonos despu√©s de cargar las plantaciones
    setTimeout(loadPoligonos, 1000);
</script>
</body>

</html>
